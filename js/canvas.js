// canvas.js - Ï∫îÎ≤ÑÏä§ Í¥ÄÎ¶¨ Î∞è Î™®Îì† Ìé∏Ïßë Í∏∞Îä•Îì§ (ÏôÑÏ†ÑÌåê + PPT Î∞©Ïãù + ÏûêÎèôÏ†ÄÏû•)

// Ï†ÑÏó≠ Î≥ÄÏàò
let selectedElement = null;
let elementCounter = 0;
let isDragging = false;
let dragOffset = { x: 0, y: 0 };
let canvasZoom = 1.0;
let clipboard = null;

// PPT Î∞©Ïãù Ï∂îÍ∞Ä Î≥ÄÏàòÎì§
let resizeHandles = [];
let isResizing = false;
let resizeHandle = '';
let startRect = {};

// ===========================================
// üéØ ÏöîÏÜå Ï∂îÍ∞Ä Í∏∞Îä•Îì§
// ===========================================

// Îπ†Î•∏ ÌÖçÏä§Ìä∏ Ï∂îÍ∞Ä (PPT Î∞©Ïãù)
function addQuickText() {
    const canvas = document.getElementById('canvas');
    const textElement = document.createElement('div');
    
    textElement.className = 'canvas-element canvas-text';
    textElement.contentEditable = true;
    textElement.innerHTML = 'ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî';
    textElement.style.left = '50px';
    textElement.style.top = '50px';
    textElement.style.position = 'absolute';
    textElement.style.minWidth = '100px';
    textElement.style.minHeight = '30px';
    textElement.style.padding = '8px';
    textElement.style.fontSize = '16px';
    textElement.style.color = '#000';
    textElement.style.background = 'rgba(255,255,255,0.9)';
    textElement.style.border = '1px dashed #ccc';
    textElement.style.cursor = 'move';
    textElement.style.outline = 'none';
    textElement.style.wordWrap = 'break-word';
    textElement.style.zIndex = '5';
    textElement.id = 'text-' + (++elementCounter);
    
    // PPT Î∞©Ïãù Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
    setupPPTEvents(textElement);
    
    canvas.appendChild(textElement);
    selectElementPPT(textElement);
    
    console.log('‚úÖ PPT Î∞©Ïãù ÌÖçÏä§Ìä∏ Ï∂îÍ∞ÄÎê®');
}

// Îπ†Î•∏ Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä
function addQuickImage() {
    const defaultImageSrc = 'https://via.placeholder.com/150x150/667eea/white?text=Ïù¥ÎØ∏ÏßÄ';
    addImageElement(defaultImageSrc, 100, 100);
}

// Îπ†Î•∏ ÎèÑÌòï Ï∂îÍ∞Ä
function addQuickShape(shapeType) {
    const canvas = document.getElementById('canvas');
    const element = document.createElement('div');
    
    element.className = 'canvas-element canvas-shape';
    element.style.left = '100px';
    element.style.top = '100px';
    element.style.position = 'absolute';
    element.style.cursor = 'move';
    element.id = 'element-' + (++elementCounter);
    element.style.zIndex = '8';
    
    if (shapeType === 'circle') {
        element.style.width = '80px';
        element.style.height = '80px';
        element.style.borderRadius = '50%';
        element.style.backgroundColor = '#667eea';
    } else if (shapeType === 'rectangle') {
        element.style.width = '120px';
        element.style.height = '80px';
        element.style.backgroundColor = '#667eea';
    }
    
    // PPT Î∞©Ïãù Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
    setupPPTEvents(element);
    
    canvas.appendChild(element);
    selectElementPPT(element);
}

// Ïù¥ÎØ∏ÏßÄ ÏöîÏÜå Ï∂îÍ∞Ä (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)
function addImageElement(src, x, y) {
    const canvas = document.getElementById('canvas');
    const element = document.createElement('img');
    
    element.className = 'canvas-element canvas-image';
    element.src = src;
    element.style.left = x + 'px';
    element.style.top = y + 'px';
    element.style.width = '150px';
    element.style.height = '150px';
    element.style.position = 'absolute';
    element.style.cursor = 'move';
    element.id = 'element-' + (++elementCounter);
    element.style.zIndex = '5';
    
    // PPT Î∞©Ïãù Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
    setupPPTEvents(element);
    
    canvas.appendChild(element);
    selectElementPPT(element);
}

// ÌÖúÌîåÎ¶øÏùÑ Î∞∞Í≤ΩÏúºÎ°ú Ï∂îÍ∞Ä (Í∏∞Ï°¥ Ìï®Ïàò Ïú†ÏßÄ)
function addTemplateAsBackground(imageSrc, templateName) {
    const canvas = document.getElementById('canvas');
    
    // Í∏∞Ï°¥ Î∞∞Í≤Ω ÌÖúÌîåÎ¶ø Ï†úÍ±∞
    const existingBg = canvas.querySelector('.canvas-background-template');
    if (existingBg) {
        existingBg.remove();
    }
    
    const bgElement = document.createElement('img');
    bgElement.className = 'canvas-element canvas-background-template';
    bgElement.src = imageSrc;
    bgElement.style.left = '0px';
    bgElement.style.top = '0px';
    bgElement.style.width = '100%';
    bgElement.style.height = '100%';
    bgElement.style.objectFit = 'cover';
    bgElement.style.zIndex = '1';
    bgElement.style.pointerEvents = 'none';
    bgElement.id = 'background-template';
    bgElement.alt = templateName;
    
    canvas.insertBefore(bgElement, canvas.firstChild);
    
    console.log(`Î∞∞Í≤Ω ÌÖúÌîåÎ¶ø Ï†ÅÏö©Îê®: ${templateName}`);
}

// ===========================================
// üé® PPT Î∞©Ïãù Ïù¥Î≤§Ìä∏ ÏãúÏä§ÌÖú (ÏûêÎèôÏ†ÄÏû• ÌÜµÌï©)
// ===========================================

// PPT Î∞©Ïãù Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï (ÏûêÎèôÏ†ÄÏû• Ï∂îÍ∞Ä)
function setupPPTEvents(element) {
    // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (ÏÑ†ÌÉù)
    element.onclick = function(e) {
        selectElementPPT(this);
        e.stopPropagation();
    };
    
    // ÎçîÎ∏îÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (Ìé∏Ïßë)
    element.ondblclick = function(e) {
        if (this.classList.contains('canvas-text')) {
            this.focus();
            // ÌÖçÏä§Ìä∏ Ï†ÑÏ≤¥ ÏÑ†ÌÉù
            const range = document.createRange();
            range.selectNodeContents(this);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }
        e.stopPropagation();
    };
    
    // üî• ÌÖçÏä§Ìä∏ Ìé∏Ïßë ÏûêÎèôÏ†ÄÏû• Ï∂îÍ∞Ä
    if (element.classList.contains('canvas-text')) {
        // ÌÖçÏä§Ìä∏ ÏûÖÎ†• Ï§ë ÏûêÎèôÏ†ÄÏû•
        element.oninput = function() {
            console.log('üìù ÌÖçÏä§Ìä∏ Î≥ÄÍ≤ΩÎê®, ÏûêÎèôÏ†ÄÏû• Ï§ë...');
            if (typeof saveCanvasState === 'function') {
                // 500ms ÌõÑ Ï†ÄÏû• (ÎÑàÎ¨¥ ÏûêÏ£º Ï†ÄÏû•ÌïòÏßÄ ÏïäÎèÑÎ°ù)
                clearTimeout(element.saveTimeout);
                element.saveTimeout = setTimeout(() => {
                    saveCanvasState();
                    console.log('üíæ ÌÖçÏä§Ìä∏ ÏûêÎèôÏ†ÄÏû• ÏôÑÎ£å');
                }, 500);
            }
        };
        
        // Ìè¨Ïª§Ïä§ ÏûÉÏùÑ Îïå Ï¶âÏãú Ï†ÄÏû•
        element.onblur = function() {
            console.log('üìù ÌÖçÏä§Ìä∏ Ìé∏Ïßë Ï¢ÖÎ£å, Ï¶âÏãú Ï†ÄÏû•');
            if (typeof saveCanvasState === 'function') {
                saveCanvasState();
            }
        };
        
        // Enter ÌÇ§ ÏûÖÎ†•Ïãú Ï†ÄÏû•
        element.onkeypress = function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                console.log('üìù Enter ÌÇ§Î°ú Ìé∏Ïßë Ï¢ÖÎ£å, Ï†ÄÏû•');
                this.blur(); // Ìé∏Ïßë Î™®Îìú Ï¢ÖÎ£å
                if (typeof saveCanvasState === 'function') {
                    saveCanvasState();
                }
            }
        };
    }
    
    // ÎìúÎûòÍ∑∏ ÏãúÏûë
    element.onmousedown = function(e) {
        if (e.target.classList.contains('resize-handle')) {
            return; // Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï∏Îì§ ÌÅ¥Î¶≠ÏãúÎäî ÎìúÎûòÍ∑∏ ÏïàÌï®
        }
        startDragPPT(e, this);
        e.preventDefault();
    };
}

// PPT Î∞©Ïãù ÏöîÏÜå ÏÑ†ÌÉù
function selectElementPPT(element) {
    // Î∞∞Í≤Ω ÌÖúÌîåÎ¶øÏùÄ ÏÑ†ÌÉù Î∂àÍ∞Ä
    if (element.classList.contains('canvas-background-template')) {
        return;
    }
    
    // Í∏∞Ï°¥ ÏÑ†ÌÉù Ìï¥Ï†ú
    clearSelectionPPT();
    
    // ÏÉà ÏöîÏÜå ÏÑ†ÌÉù
    selectedElement = element;
    element.style.outline = '2px solid #0078d4';
    
    // PPT Î∞©Ïãù Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï∏Îì§ Ï∂îÍ∞Ä
    addResizeHandlesPPT(element);
    
    // ÏÑ†ÌÉùÎêú ÎèÑÍµ¨Îì§ ÌëúÏãú
    const selectedTools = document.getElementById('selected-tools');
    if (selectedTools) selectedTools.style.display = 'block';
    
    // PPT Ìé∏ÏßëÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏
    if (typeof updatePPTEditor === 'function') {
        updatePPTEditor(element);
    }
    
    console.log('üéØ PPT Î∞©Ïãù ÏÑ†ÌÉùÎê®:', element.id);
}

// PPT Î∞©Ïãù ÏÑ†ÌÉù Ìï¥Ï†ú
function clearSelectionPPT() {
    if (selectedElement) {
        selectedElement.style.outline = '';
        removeResizeHandlesPPT();
    }
    selectedElement = null;
    
    const selectedTools = document.getElementById('selected-tools');
    if (selectedTools) selectedTools.style.display = 'none';
}

// PPT Î∞©Ïãù Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï∏Îì§ Ï∂îÍ∞Ä
function addResizeHandlesPPT(element) {
    removeResizeHandlesPPT();
    
    const positions = [
        {name: 'nw', style: 'top: -4px; left: -4px; cursor: nw-resize;'},
        {name: 'n', style: 'top: -4px; left: 50%; transform: translateX(-50%); cursor: n-resize;'},
        {name: 'ne', style: 'top: -4px; right: -4px; cursor: ne-resize;'},
        {name: 'e', style: 'top: 50%; right: -4px; transform: translateY(-50%); cursor: e-resize;'},
        {name: 'se', style: 'bottom: -4px; right: -4px; cursor: se-resize;'},
        {name: 's', style: 'bottom: -4px; left: 50%; transform: translateX(-50%); cursor: s-resize;'},
        {name: 'sw', style: 'bottom: -4px; left: -4px; cursor: sw-resize;'},
        {name: 'w', style: 'top: 50%; left: -4px; transform: translateY(-50%); cursor: w-resize;'}
    ];
    
    positions.forEach(pos => {
        const handle = document.createElement('div');
        handle.className = 'resize-handle resize-handle-' + pos.name;
        handle.style.cssText = `
            position: absolute;
            width: 8px;
            height: 8px;
            background: #0078d4;
            border: 1px solid white;
            z-index: 1000;
            ${pos.style}
        `;
        handle.dataset.direction = pos.name;
        
        // Î¶¨ÏÇ¨Ïù¥Ï¶à Ïù¥Î≤§Ìä∏
        handle.onmousedown = function(e) {
            startResizePPT(e, pos.name);
            e.stopPropagation();
            e.preventDefault();
        };
        
        element.appendChild(handle);
        resizeHandles.push(handle);
    });
}

// PPT Î∞©Ïãù Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï∏Îì§ Ï†úÍ±∞
function removeResizeHandlesPPT() {
    resizeHandles.forEach(handle => {
        if (handle.parentNode) {
            handle.parentNode.removeChild(handle);
        }
    });
    resizeHandles = [];
}

// PPT Î∞©Ïãù ÎìúÎûòÍ∑∏ ÏãúÏûë
function startDragPPT(e, element) {
    isDragging = true;
    
    const rect = element.getBoundingClientRect();
    const canvasRect = document.getElementById('canvas').getBoundingClientRect();
    
    dragOffset.x = e.clientX - rect.left;
    dragOffset.y = e.clientY - rect.top;
    
    element.style.zIndex = '999';
    
    // Ï†ÑÏó≠ ÎßàÏö∞Ïä§ Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
    document.onmousemove = function(e) {
        dragPPT(e, element);
    };
    
    document.onmouseup = function() {
        stopDragPPT(element);
    };
}

// PPT Î∞©Ïãù ÎìúÎûòÍ∑∏
function dragPPT(e, element) {
    if (!isDragging) return;
    
    const canvas = document.getElementById('canvas');
    const canvasRect = canvas.getBoundingClientRect();
    
    let newX = e.clientX - canvasRect.left - dragOffset.x;
    let newY = e.clientY - canvasRect.top - dragOffset.y;
    
    // Í≤ΩÍ≥Ñ Ï†úÌïú
    newX = Math.max(0, Math.min(newX, canvas.offsetWidth - element.offsetWidth));
    newY = Math.max(0, Math.min(newY, canvas.offsetHeight - element.offsetHeight));
    
    element.style.left = newX + 'px';
    element.style.top = newY + 'px';
    
    // Ìé∏ÏßëÍ∏∞ ÏúÑÏπòÍ∞í ÏóÖÎç∞Ïù¥Ìä∏
    updateEditorPositionValues(element);
}

// PPT Î∞©Ïãù ÎìúÎûòÍ∑∏ Ï¢ÖÎ£å
function stopDragPPT(element) {
    isDragging = false;
    element.style.zIndex = '';
    
    document.onmousemove = null;
    document.onmouseup = null;
    
    // Ïã§ÏãúÍ∞Ñ Ï†ÄÏû•
    if (typeof saveCanvasState === 'function') {
        saveCanvasState();
    }
}

// PPT Î∞©Ïãù Î¶¨ÏÇ¨Ïù¥Ï¶à ÏãúÏûë
function startResizePPT(e, direction) {
    isResizing = true;
    resizeHandle = direction;
    
    const rect = selectedElement.getBoundingClientRect();
    const canvasRect = document.getElementById('canvas').getBoundingClientRect();
    
    startRect = {
        left: rect.left - canvasRect.left,
        top: rect.top - canvasRect.top,
        width: rect.width,
        height: rect.height,
        mouseX: e.clientX,
        mouseY: e.clientY
    };
    
    document.onmousemove = resizePPT;
    document.onmouseup = stopResizePPT;
}

// PPT Î∞©Ïãù Î¶¨ÏÇ¨Ïù¥Ï¶à
function resizePPT(e) {
    if (!isResizing || !selectedElement) return;
    
    const deltaX = e.clientX - startRect.mouseX;
    const deltaY = e.clientY - startRect.mouseY;
    
    let newLeft = startRect.left;
    let newTop = startRect.top;
    let newWidth = startRect.width;
    let newHeight = startRect.height;
    
    // Î∞©Ìñ•Ïóê Îî∞Î•∏ Î¶¨ÏÇ¨Ïù¥Ï¶à
    switch (resizeHandle) {
        case 'se': // Ïö∞ÌïòÎã®
            newWidth = Math.max(50, startRect.width + deltaX);
            newHeight = Math.max(30, startRect.height + deltaY);
            break;
        case 'sw': // Ï¢åÌïòÎã®
            newWidth = Math.max(50, startRect.width - deltaX);
            newHeight = Math.max(30, startRect.height + deltaY);
            newLeft = startRect.left + deltaX;
            if (newWidth === 50) newLeft = startRect.left + startRect.width - 50;
            break;
        case 'ne': // Ïö∞ÏÉÅÎã®
            newWidth = Math.max(50, startRect.width + deltaX);
            newHeight = Math.max(30, startRect.height - deltaY);
            newTop = startRect.top + deltaY;
            if (newHeight === 30) newTop = startRect.top + startRect.height - 30;
            break;
        case 'nw': // Ï¢åÏÉÅÎã®
            newWidth = Math.max(50, startRect.width - deltaX);
            newHeight = Math.max(30, startRect.height - deltaY);
            newLeft = startRect.left + deltaX;
            newTop = startRect.top + deltaY;
            if (newWidth === 50) newLeft = startRect.left + startRect.width - 50;
            if (newHeight === 30) newTop = startRect.top + startRect.height - 30;
            break;
        case 'n': // ÏÉÅÎã®
            newHeight = Math.max(30, startRect.height - deltaY);
            newTop = startRect.top + deltaY;
            if (newHeight === 30) newTop = startRect.top + startRect.height - 30;
            break;
        case 's': // ÌïòÎã®
            newHeight = Math.max(30, startRect.height + deltaY);
            break;
        case 'e': // Ïö∞Ï∏°
            newWidth = Math.max(50, startRect.width + deltaX);
            break;
        case 'w': // Ï¢åÏ∏°
            newWidth = Math.max(50, startRect.width - deltaX);
            newLeft = startRect.left + deltaX;
            if (newWidth === 50) newLeft = startRect.left + startRect.width - 50;
            break;
    }
    
    // Ïä§ÌÉÄÏùº Ï†ÅÏö©
    selectedElement.style.left = newLeft + 'px';
    selectedElement.style.top = newTop + 'px';
    selectedElement.style.width = newWidth + 'px';
    selectedElement.style.height = newHeight + 'px';
    
    // Ìé∏ÏßëÍ∏∞ ÏúÑÏπòÍ∞í ÏóÖÎç∞Ïù¥Ìä∏
    updateEditorPositionValues(selectedElement);
}

// PPT Î∞©Ïãù Î¶¨ÏÇ¨Ïù¥Ï¶à Ï¢ÖÎ£å
function stopResizePPT() {
    isResizing = false;
    resizeHandle = '';
    
    document.onmousemove = null;
    document.onmouseup = null;
    
    // Ïã§ÏãúÍ∞Ñ Ï†ÄÏû•
    if (typeof saveCanvasState === 'function') {
        saveCanvasState();
    }
}

// ===========================================
// üíæ ÏûêÎèôÏ†ÄÏû• Î∞è ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ¶¨
// ===========================================

// Ï∫îÎ≤ÑÏä§ ÏÉÅÌÉú ÏûêÎèôÏ†ÄÏû•
function saveCanvasState() {
    try {
        const projectData = {
            name: document.getElementById('project-title').textContent,
            canvas: document.getElementById('canvas').innerHTML,
            timestamp: new Date().toISOString(),
            elements: []
        };
        
        // Ï∫îÎ≤ÑÏä§ ÏöîÏÜåÎì§ ÏàòÏßë
        const elements = document.querySelectorAll('.canvas-element:not(.canvas-background-template)');
        elements.forEach((element, index) => {
            const elementData = {
                id: element.id,
                type: getElementType(element),
                style: element.style.cssText,
                position: {
                    left: element.style.left,
                    top: element.style.top
                }
            };
            
            // ÌÖçÏä§Ìä∏ ÎÇ¥Ïö© Ï†ÄÏû•
            if (element.classList.contains('canvas-text')) {
                elementData.content = element.innerHTML;
                elementData.textContent = element.textContent;
            }
            // Ïù¥ÎØ∏ÏßÄ ÏÜåÏä§ Ï†ÄÏû•
            else if (element.classList.contains('canvas-image')) {
                elementData.src = element.src;
            }
            
            projectData.elements.push(elementData);
        });
        
        // localStorageÏóê Ï†ÄÏû•
        localStorage.setItem('currentProject', JSON.stringify(projectData));
        localStorage.setItem('lastSaved', new Date().toLocaleString());
        
        console.log('üíæ ÌîÑÎ°úÏ†ùÌä∏ ÏûêÎèôÏ†ÄÏû• ÏôÑÎ£å:', projectData.elements.length + 'Í∞ú ÏöîÏÜå');
        
    } catch (error) {
        console.error('‚ùå ÏûêÎèôÏ†ÄÏû• Ïã§Ìå®:', error);
    }
}

// ÌîÑÎ°úÏ†ùÌä∏ Î∂àÎü¨Ïò§Í∏∞ (Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ)
function loadProject() {
    const saved = localStorage.getItem('currentProject');
    if (saved) {
        try {
            const projectData = JSON.parse(saved);
            
            // ÌîÑÎ°úÏ†ùÌä∏ Ï†úÎ™© Î≥µÏõê
            document.getElementById('project-title').textContent = projectData.name;
            
            // Ï∫îÎ≤ÑÏä§ Ï¥àÍ∏∞Ìôî
            const canvas = document.getElementById('canvas');
            canvas.innerHTML = '';
            
            // ÏöîÏÜåÎì§ Î≥µÏõê
            projectData.elements.forEach(elementData => {
                let element;
                
                if (elementData.type === 'text') {
                    element = document.createElement('div');
                    element.className = 'canvas-element canvas-text';
                    element.contentEditable = true;
                    element.innerHTML = elementData.content || elementData.textContent || 'ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî';
                } else if (elementData.type === 'image') {
                    element = document.createElement('img');
                    element.className = 'canvas-element canvas-image';
                    element.src = elementData.src;
                } else if (elementData.type === 'shape') {
                    element = document.createElement('div');
                    element.className = 'canvas-element canvas-shape';
                }
                
                if (element) {
                    element.id = elementData.id;
                    element.style.cssText = elementData.style;
                    element.style.position = 'absolute';
                    element.style.cursor = 'move';
                    
                    // PPT Î∞©Ïãù Ïù¥Î≤§Ìä∏ Ïó∞Í≤∞
                    setupPPTEvents(element);
                    
                    canvas.appendChild(element);
                }
            });
            
            const lastSaved = localStorage.getItem('lastSaved');
            console.log(`üìÇ ÌîÑÎ°úÏ†ùÌä∏ Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å: ${projectData.elements.length}Í∞ú ÏöîÏÜå (Ï†ÄÏû•ÏãúÍ∞Ñ: ${lastSaved})`);
            return true;
            
        } catch (error) {
            console.error('‚ùå ÌîÑÎ°úÏ†ùÌä∏ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:', error);
            localStorage.removeItem('currentProject'); // ÏÜêÏÉÅÎêú Îç∞Ïù¥ÌÑ∞ Ï†úÍ±∞
        }
    }
    return false;
}

// ===========================================
// üñ±Ô∏è Í∏∞Ï°¥ ÎìúÎûòÍ∑∏ Ïù¥Îèô Í∏∞Îä• (Ìò∏ÌôòÏÑ± Ïú†ÏßÄ)
// ===========================================

function setupDragEvents(element) {
    element.addEventListener('mousedown', function(e) {
        if (e.button !== 0) return; // ÏôºÏ™Ω ÌÅ¥Î¶≠Îßå
        
        isDragging = true;
        const canvas = document.getElementById('canvas');
        const canvasRect = canvas.getBoundingClientRect();
        const elementRect = element.getBoundingClientRect();
        
        // ÎìúÎûòÍ∑∏ Ïò§ÌîÑÏÖã Í≥ÑÏÇ∞
        dragOffset.x = e.clientX - elementRect.left;
        dragOffset.y = e.clientY - elementRect.top;
        
        // ÏöîÏÜå ÏÑ†ÌÉù
        selectElement(element);
        
        // ÎìúÎûòÍ∑∏ Ïä§ÌÉÄÏùº Ï†ÅÏö©
        element.style.opacity = '0.7';
        element.style.zIndex = '999';
        
        e.preventDefault();
        e.stopPropagation();
    });
}

// Ï†ÑÏó≠ ÎßàÏö∞Ïä§ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà (init.jsÏóêÏÑú Ìò∏Ï∂ú)
function setupGlobalDragEvents() {
    document.addEventListener('mousemove', function(e) {
        if (!isDragging || !selectedElement) return;
        
        const canvas = document.getElementById('canvas');
        const canvasRect = canvas.getBoundingClientRect();
        
        // ÏÉà ÏúÑÏπò Í≥ÑÏÇ∞
        let newX = e.clientX - canvasRect.left - dragOffset.x;
        let newY = e.clientY - canvasRect.top - dragOffset.y;
        
        // Ï∫îÎ≤ÑÏä§ Í≤ΩÍ≥Ñ Ï†úÌïú
        newX = Math.max(0, Math.min(newX, canvasRect.width - 50));
        newY = Math.max(0, Math.min(newY, canvasRect.height - 50));
        
        // ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
        selectedElement.style.left = newX + 'px';
        selectedElement.style.top = newY + 'px';
        
        // Ìé∏ÏßëÍ∏∞ ÏúÑÏπò Í∞í ÏóÖÎç∞Ïù¥Ìä∏
        updateEditorPositionValues(selectedElement);
        
        e.preventDefault();
    });
    
    document.addEventListener('mouseup', function(e) {
        if (isDragging && selectedElement) {
            // ÎìúÎûòÍ∑∏ Ï¢ÖÎ£å
            isDragging = false;
            selectedElement.style.opacity = '';
            selectedElement.style.zIndex = selectedElement.style.zIndex === '999' ? '5' : selectedElement.style.zIndex;
            
            // Ïã§ÏãúÍ∞Ñ Ï†ÄÏû•
            if (typeof saveCanvasState === 'function') {
                saveCanvasState();
            }
        }
    });
}

// Ìé∏ÏßëÍ∏∞ ÏúÑÏπòÍ∞í ÏóÖÎç∞Ïù¥Ìä∏
function updateEditorPositionValues(element) {
    const textX = document.getElementById('text-x');
    const textY = document.getElementById('text-y');
    const imageX = document.getElementById('image-x');
    const imageY = document.getElementById('image-y');
    
    if (element.classList.contains('canvas-text')) {
        if (textX) textX.value = parseInt(element.style.left);
        if (textY) textY.value = parseInt(element.style.top);
    } else if (element.classList.contains('canvas-image')) {
        if (imageX) imageX.value = parseInt(element.style.left);
        if (imageY) imageY.value = parseInt(element.style.top);
    }
}

// ===========================================
// üéØ ÏöîÏÜå ÏÑ†ÌÉù Î∞è Í¥ÄÎ¶¨ (Ìò∏ÌôòÏÑ± Ïú†ÏßÄ)
// ===========================================

// ÏöîÏÜå ÏÑ†ÌÉù (Í∏∞Ï°¥ Ìï®Ïàò Í∞úÏÑ†)
function selectElement(element) {
    // Î∞∞Í≤Ω ÌÖúÌîåÎ¶øÏùÄ ÏÑ†ÌÉù Î∂àÍ∞Ä
    if (element.classList.contains('canvas-background-template')) {
        return;
    }
    
    // Ïù¥Ï†Ñ ÏÑ†ÌÉù Ìï¥Ï†ú
    if (selectedElement) {
        selectedElement.classList.remove('selected');
        selectedElement.style.outline = '';
    }
    
    // ÏÉà ÏöîÏÜå ÏÑ†ÌÉù
    selectedElement = element;
    element.classList.add('selected');
    element.style.outline = '2px solid #667eea';
    
    // ÏÑ†ÌÉùÎêú ÎèÑÍµ¨Îì§ ÌëúÏãú
    const selectedTools = document.getElementById('selected-tools');
    if (selectedTools) selectedTools.style.display = 'block';
    
    // PPT Ìé∏ÏßëÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏
    if (typeof updatePPTEditor === 'function') {
        updatePPTEditor(element);
    }
}

// ÏÑ†ÌÉù Ìï¥Ï†ú
function deselectAllElements() {
    clearSelectionPPT(); // PPT Î∞©ÏãùÏúºÎ°ú ÌÜµÌï©
}

// ÏÑ†ÌÉùÎêú ÏöîÏÜå ÏÇ≠Ï†ú (Í∏∞Ï°¥ Ìï®Ïàò Ïú†ÏßÄ)
function deleteSelectedElement() {
    if (selectedElement) {
        selectedElement.remove();
        selectedElement = null;
        
        // Ìé∏ÏßëÍ∏∞ Ï¥àÍ∏∞Ìôî
        const noSelection = document.getElementById('no-selection');
        const textEditor = document.getElementById('text-editor');
        const imageEditor = document.getElementById('image-editor');
        const selectedTools = document.getElementById('selected-tools');
        
        if (noSelection) noSelection.style.display = 'block';
        if (textEditor) textEditor.style.display = 'none';
        if (imageEditor) imageEditor.style.display = 'none';
        if (selectedTools) selectedTools.style.display = 'none';
        
        // Ïã§ÏãúÍ∞Ñ Ï†ÄÏû•
        if (typeof saveCanvasState === 'function') {
            saveCanvasState();
        }
    }
}

// ===========================================
// üìê Ï†ïÎ†¨ Í∏∞Îä•Îì§
// ===========================================

function alignLeft() {
    if (!selectedElement) return;
    selectedElement.style.left = '10px';
    updateEditorPositionValues(selectedElement);
    if (typeof saveCanvasState === 'function') saveCanvasState();
}

function alignCenter() {
    if (!selectedElement) return;
    const canvas = document.getElementById('canvas');
    const canvasWidth = canvas.offsetWidth;
    const elementWidth = selectedElement.offsetWidth;
    const centerX = (canvasWidth - elementWidth) / 2;
    selectedElement.style.left = centerX + 'px';
    updateEditorPositionValues(selectedElement);
    if (typeof saveCanvasState === 'function') saveCanvasState();
}

function alignRight() {
    if (!selectedElement) return;
    const canvas = document.getElementById('canvas');
    const canvasWidth = canvas.offsetWidth;
    const elementWidth = selectedElement.offsetWidth;
    const rightX = canvasWidth - elementWidth - 10;
    selectedElement.style.left = rightX + 'px';
    updateEditorPositionValues(selectedElement);
    if (typeof saveCanvasState === 'function') saveCanvasState();
}

function alignTop() {
    if (!selectedElement) return;
    selectedElement.style.top = '10px';
    updateEditorPositionValues(selectedElement);
    if (typeof saveCanvasState === 'function') saveCanvasState();
}

function alignMiddle() {
    if (!selectedElement) return;
    const canvas = document.getElementById('canvas');
    const canvasHeight = canvas.offsetHeight;
    const elementHeight = selectedElement.offsetHeight;
    const middleY = (canvasHeight - elementHeight) / 2;
    selectedElement.style.top = middleY + 'px';
    updateEditorPositionValues(selectedElement);
    if (typeof saveCanvasState === 'function') saveCanvasState();
}

function alignBottom() {
    if (!selectedElement) return;
    const canvas = document.getElementById('canvas');
    const canvasHeight = canvas.offsetHeight;
    const elementHeight = selectedElement.offsetHeight;
    const bottomY = canvasHeight - elementHeight - 10;
    selectedElement.style.top = bottomY + 'px';
    updateEditorPositionValues(selectedElement);
    if (typeof saveCanvasState === 'function') saveCanvasState();
}

// ===========================================
// üìö Î†àÏù¥Ïñ¥ Í¥ÄÎ¶¨
// ===========================================

function bringToFront() {
    if (!selectedElement) return;
    selectedElement.style.zIndex = '100';
    if (typeof saveCanvasState === 'function') saveCanvasState();
}

function sendToBack() {
    if (!selectedElement) return;
    selectedElement.style.zIndex = '2';
    if (typeof saveCanvasState === 'function') saveCanvasState();
}

function moveForward() {
    if (!selectedElement) return;
    const currentZ = parseInt(selectedElement.style.zIndex) || 5;
    selectedElement.style.zIndex = (currentZ + 1).toString();
    if (typeof saveCanvasState === 'function') saveCanvasState();
}

function moveBackward() {
    if (!selectedElement) return;
    const currentZ = parseInt(selectedElement.style.zIndex) || 5;
    selectedElement.style.zIndex = Math.max(2, currentZ - 1).toString();
    if (typeof saveCanvasState === 'function') saveCanvasState();
}

// ===========================================
// üìã Î≥µÏÇ¨/Î∂ôÏó¨ÎÑ£Í∏∞/Í∑∏Î£π
// ===========================================

function copySelectedElement() {
    if (!selectedElement) return;
    
    clipboard = {
        className: selectedElement.className,
        innerHTML: selectedElement.innerHTML,
        textContent: selectedElement.textContent,
        src: selectedElement.src,
        style: selectedElement.style.cssText,
        type: getElementType(selectedElement)
    };
    
    console.log('ÏöîÏÜå Î≥µÏÇ¨Îê®');
    
    // ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞±
    const originalOpacity = selectedElement.style.opacity;
    selectedElement.style.opacity = '0.5';
    setTimeout(() => {
        if (selectedElement) selectedElement.style.opacity = originalOpacity;
    }, 200);
}

function duplicateElement() {
    if (!selectedElement) return;
    
    const canvas = document.getElementById('canvas');
    const type = getElementType(selectedElement);
    let newElement;
    
    if (type === 'text') {
        newElement = document.createElement('div');
        newElement.textContent = selectedElement.textContent;
        newElement.onclick = function() {
            if (typeof selectTextElement === 'function') {
                selectTextElement(this);
            } else {
                selectElementPPT(this);
            }
        };
    } else if (type === 'image') {
        newElement = document.createElement('img');
        newElement.src = selectedElement.src;
        newElement.onclick = function() {
            selectElementPPT(this);
        };
    } else if (type === 'shape') {
        newElement = document.createElement('div');
        newElement.onclick = function() {
            selectElementPPT(this);
        };
    } else {
        return;
    }
    
    // Ïä§ÌÉÄÏùº Î≥µÏÇ¨
    newElement.className = selectedElement.className;
    newElement.style.cssText = selectedElement.style.cssText;
    
    // ÏÉà IDÏôÄ ÏúÑÏπò ÏÑ§Ï†ï
    newElement.id = 'element-' + (++elementCounter);
    const currentLeft = parseInt(selectedElement.style.left) || 0;
    const currentTop = parseInt(selectedElement.style.top) || 0;
    newElement.style.left = (currentLeft + 20) + 'px';
    newElement.style.top = (currentTop + 20) + 'px';
    
    // PPT Î∞©Ïãù Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
    setupPPTEvents(newElement);
    
    canvas.appendChild(newElement);
    selectElementPPT(newElement);
    
    if (typeof saveCanvasState === 'function') saveCanvasState();
}

function groupElements() {
    // Í∑∏Î£π Í∏∞Îä•ÏùÄ Î≥µÏû°ÌïòÎØÄÎ°ú ÏùºÎã® ÏïåÎ¶ºÎßå
    alert('Í∑∏Î£π Í∏∞Îä•ÏùÄ Í∞úÎ∞ú ÏòàÏ†ïÏûÖÎãàÎã§.');
}

// ===========================================
// üîç Ï§å Í∏∞Îä•
// ===========================================

function zoomIn() {
    canvasZoom = Math.min(canvasZoom + 0.1, 3.0);
    applyZoom();
}

function zoomOut() {
    canvasZoom = Math.max(canvasZoom - 0.1, 0.3);
    applyZoom();
}

function applyZoom() {
    const canvas = document.getElementById('canvas');
    const zoomLevel = document.getElementById('zoom-level');
    
    canvas.style.transform = `scale(${canvasZoom})`;
    canvas.style.transformOrigin = 'top left';
    
    if (zoomLevel) {
        zoomLevel.textContent = Math.round(canvasZoom * 100) + '%';
    }
}

// ===========================================
// üìÑ Ï∫îÎ≤ÑÏä§ Í¥ÄÎ¶¨
// ===========================================

// Î∞∞Í≤Ω Î≥ÄÍ≤Ω (Í∏∞Ï°¥ Ìï®Ïàò Ïú†ÏßÄ)
function changeBackground(background) {
    removeBackgroundTemplate();
    document.getElementById('canvas').style.background = background;
    if (typeof saveCanvasState === 'function') saveCanvasState();
}

// Î∞∞Í≤Ω ÌÖúÌîåÎ¶ø Ï†úÍ±∞ (Í∏∞Ï°¥ Ìï®Ïàò Ïú†ÏßÄ)
function removeBackgroundTemplate() {
    const canvas = document.getElementById('canvas');
    const bgTemplate = canvas.querySelector('.canvas-background-template');
    if (bgTemplate) {
        bgTemplate.remove();
        console.log('Î∞∞Í≤Ω ÌÖúÌîåÎ¶ø Ï†úÍ±∞Îê®');
        return true;
    }
    return false;
}

// Ï∫îÎ≤ÑÏä§ Ï¥àÍ∏∞Ìôî (Í∏∞Ï°¥ Ìï®Ïàò Ïú†ÏßÄ)
function clearCanvas() {
    if (confirm('Ï∫îÎ≤ÑÏä§Ïùò Î™®Îì† ÏöîÏÜåÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        const canvas = document.getElementById('canvas');
        const elements = canvas.querySelectorAll('.canvas-element');
        elements.forEach(element => element.remove());
        
        clearSelectionPPT();
        const noSelection = document.getElementById('no-selection');
        const textEditor = document.getElementById('text-editor');
        const imageEditor = document.getElementById('image-editor');
        const selectedTools = document.getElementById('selected-tools');
        
        if (noSelection) noSelection.style.display = 'block';
        if (textEditor) textEditor.style.display = 'none';
        if (imageEditor) imageEditor.style.display = 'none';
        if (selectedTools) selectedTools.style.display = 'none';
        
        // Î∞∞Í≤ΩÎèÑ Ï¥àÍ∏∞Ìôî
        canvas.style.background = '#333';
        
        if (typeof saveCanvasState === 'function') saveCanvasState();
        console.log('Ï∫îÎ≤ÑÏä§ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
    }
}

// Ï∫îÎ≤ÑÏä§ Î¶¨ÏÖã (Ï§å Ìè¨Ìï®)
function resetCanvas() {
    if (confirm('Ï∫îÎ≤ÑÏä§Î•º ÏôÑÏ†ÑÌûà Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Ï§å, Î∞∞Í≤Ω Îì± Î™®Îì† ÏÑ§Ï†ï Ìè¨Ìï®)')) {
        clearCanvas();
        
        // Ï§å Î¶¨ÏÖã
        canvasZoom = 1.0;
        applyZoom();
        
        // Î∞∞Í≤Ω Î¶¨ÏÖã
        const canvas = document.getElementById('canvas');
        canvas.style.background = '#333';
        canvas.style.transform = '';
        
        console.log('Ï∫îÎ≤ÑÏä§ ÏôÑÏ†Ñ Î¶¨ÏÖã ÏôÑÎ£å');
    }
}

// ===========================================
// üõ†Ô∏è Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
// ===========================================

// ÏöîÏÜå ÌÉÄÏûÖ ÌôïÏù∏
function getElementType(element) {
    if (element.classList.contains('canvas-text')) return 'text';
    if (element.classList.contains('canvas-image')) return 'image';
    if (element.classList.contains('canvas-shape')) return 'shape';
    if (element.classList.contains('canvas-background-template')) return 'background-template';
    return 'unknown';
}

// ===========================================
// üöÄ Ï¥àÍ∏∞Ìôî
// ===========================================

document.addEventListener('DOMContentLoaded', function() {
    // Ï†ÑÏó≠ ÎìúÎûòÍ∑∏ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï (Ìò∏ÌôòÏÑ±)
    setupGlobalDragEvents();
    
    // Ï∫îÎ≤ÑÏä§ ÌÅ¥Î¶≠Ïãú ÏÑ†ÌÉù Ìï¥Ï†ú
    const canvas = document.getElementById('canvas');
    if (canvas) {
        canvas.addEventListener('click', function(e) {
            if (e.target === canvas) {
                clearSelectionPPT();
            }
        });
    }
    
    console.log('‚úÖ Canvas.js ÏôÑÏ†ÑÌåê Î°úÎìú ÏôÑÎ£å - PPT Î∞©Ïãù Ìé∏Ïßë + ÏûêÎèôÏ†ÄÏû• + Î™®Îì† Í∏∞Îä• ÌôúÏÑ±Ìôî');
});